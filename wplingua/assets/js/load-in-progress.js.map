{"version":3,"file":"load-in-progress.js","sources":["load-in-progress.js"],"sourcesContent":["/*!*\r\n **                 _     _                         \r\n ** __      ___ __ | |   (_)_ __   __ _ _   _  __ _ \r\n ** \\ \\ /\\ / / '_ \\| |   | | '_ \\ / _` | | | |/ _` |\r\n **  \\ V  V /| |_) | |___| | | | | (_| | |_| | (_| |\r\n **   \\_/\\_/ | .__/|_____|_|_| |_|\\__, |\\__,_|\\__,_|\r\n **          |_|                  |___/             \r\n **\r\n **        -- wpLingua | WordPress plugin --\r\n **   Translate and make your website multilingual\r\n **\r\n **     https://github.com/julien-jacob/wplingua\r\n **      https://wordpress.org/plugins/wplingua/\r\n **              https://wplingua.com/\r\n **\r\n **/\r\n\r\njQuery(document).ready(function ($) {\r\n\r\n    /**\r\n     * Load the translation, replace texts and reload the page\r\n     */\r\n\r\n    let wplngLoadInProgressPercentageMin = 1;\r\n    let wplngLoadInProgressPercentageMax = 1;\r\n    let wplngLoadInProgressErrorOccurred = false;\r\n\r\n    wplngLoadInProgressProcess();\r\n\r\n    function wplngLoadInProgressProcess() {\r\n\r\n        /**\r\n         * Check data and progress bar container\r\n         */\r\n\r\n        if (!$(\"#wplng-in-progress-container\").length) {\r\n            wplngLoadInProgressError(\"Mode loaded without the progress bar container\");\r\n            return;\r\n        }\r\n\r\n        if (typeof wplngLoadInProgressData === 'undefined') {\r\n            wplngLoadInProgressError(\"Invalide data (wplngLoadInProgressData undefined).\");\r\n            console.info(wplngLoadInProgressData);\r\n            return;\r\n        }\r\n\r\n        if (typeof wplngLoadInProgressData.urlAjax !== 'string') {\r\n            wplngLoadInProgressError(\"Invalide data (wplngLoadInProgressData.urlAjax).\");\r\n            console.info(wplngLoadInProgressData.urlAjax);\r\n            return;\r\n        }\r\n\r\n        if (typeof wplngLoadInProgressData.urlReload !== 'string') {\r\n            wplngLoadInProgressError(\"Invalide data (wplngLoadInProgressData.urlReload).\");\r\n            console.info(wplngLoadInProgressData.urlReload);\r\n            return;\r\n        }\r\n\r\n        if (typeof wplngLoadInProgressData.nonce !== 'string' || wplngLoadInProgressData.nonce.length === 0) {\r\n            wplngLoadInProgressError(\"Invalide data (wplngLoadInProgressData.nonce).\");\r\n            console.info(wplngLoadInProgressData.nonce);\r\n            return;\r\n        }\r\n\r\n        if (typeof wplngLoadInProgressData.language !== 'string'\r\n            || wplngLoadInProgressData.language.length !== 2\r\n        ) {\r\n            wplngLoadInProgressError(\"Invalide data (wplngLoadInProgressData.language).\");\r\n            console.info(wplngLoadInProgressData.language);\r\n            return;\r\n        }\r\n\r\n        if (typeof wplngLoadInProgressData.chunks !== 'object'\r\n            || wplngLoadInProgressData.chunks.length === 0\r\n        ) {\r\n            wplngLoadInProgressError(\"Invalide data (wplngLoadInProgressData.chunks).\");\r\n            console.info(wplngLoadInProgressData.chunks);\r\n            return;\r\n        }\r\n\r\n        /**\r\n         * Load the first chunk\r\n         */\r\n\r\n        wplngLoadInProgressProcessCkunk(\r\n            0,\r\n            wplngLoadInProgressData.urlAjax,\r\n            wplngLoadInProgressData.urlReload,\r\n            wplngLoadInProgressData.language,\r\n            wplngLoadInProgressData.chunks\r\n        );\r\n\r\n    }\r\n\r\n    function wplngLoadInProgressProcessCkunk(counter, urlAjax, urlReload, language, chunks) {\r\n\r\n        if (!chunks[counter]\r\n            || typeof chunks[counter] !== 'object'\r\n            || typeof chunks[counter].percentage !== 'number'\r\n            || typeof chunks[counter].texts !== 'object'\r\n            || chunks[counter].texts.length === 0\r\n        ) {\r\n            wplngLoadInProgressError(\"Invalide text chunk.\");\r\n            console.info(chunks[counter]);\r\n            return;\r\n        }\r\n\r\n        let percentage = chunks[counter].percentage;\r\n        let texts = chunks[counter].texts;\r\n\r\n        wplngLoadInProgressPercentageMax = percentage;\r\n\r\n        $.ajax({\r\n            url: urlAjax,\r\n            method: \"POST\",\r\n            data: {\r\n                action: 'wplng_load_in_progress',\r\n                wplng_language: language,\r\n                wplng_texts: texts,\r\n                wplng_nonce: wplngLoadInProgressData.nonce,\r\n            },\r\n            success: function (response) {\r\n\r\n                if (!response.success) {\r\n\r\n                    if (typeof response.data === \"object\"\r\n                        && typeof response.data.error_message === \"string\"\r\n                    ) {\r\n                        wplngLoadInProgressError(\"Translation AJAX call fail (message: \" + response.data.error_message + \").\");\r\n                    } else {\r\n                        wplngLoadInProgressError(\"Translation AJAX call fail (response.success is false, unknow message).\");\r\n                    }\r\n\r\n                    return;\r\n                }\r\n\r\n                wplngLoadInProgressPercentageMin = percentage;\r\n\r\n                let translations = response.data;\r\n                let map = Object.create(null);\r\n\r\n                if (Array.isArray(translations)) {\r\n                    translations.forEach(function (t) {\r\n                        if (t && typeof t.source === 'string') {\r\n                            map[t.source.trim()] = (typeof t.translation === 'string') ? t.translation : '';\r\n                        }\r\n                    });\r\n                }\r\n\r\n                $(\".wplng-in-progress-text\").each(function () {\r\n                    const domText = $(this).text().trim();\r\n                    const translated = map[domText];\r\n                    if (typeof translated === 'string' && translated.length > 0) {\r\n                        $(this).replaceWith(translated);\r\n                    }\r\n                });\r\n\r\n                /**\r\n                 * Process the next chunk or exit\r\n                 */\r\n\r\n                if (typeof chunks[counter + 1] === 'undefined') {\r\n\r\n                    // We are in the last chunk, page is translated, no next chunk\r\n                    wplngLoadInProgressUpdatePercentValue(100);\r\n                    window.location.href = urlReload;\r\n\r\n                } else {\r\n\r\n                    // Process the next chunk\r\n                    wplngLoadInProgressProcessCkunk(\r\n                        counter + 1,\r\n                        urlAjax,\r\n                        urlReload,\r\n                        language,\r\n                        chunks\r\n                    );\r\n                }\r\n\r\n            },\r\n            error: function (response) {\r\n                wplngLoadInProgressError(\"Translation AJAX call fail (callback error).\");\r\n                return;\r\n            }\r\n        });\r\n\r\n    }\r\n\r\n    /**\r\n     * Display error\r\n     */\r\n\r\n    function wplngLoadInProgressError(message) {\r\n\r\n        wplngLoadInProgressErrorOccurred = true;\r\n\r\n        $(\"#wplng-in-progress-message\").hide();\r\n        $(\"#wplng-progress-bar\").hide();\r\n        $(\"#wplng-in-progress-error\").show();\r\n\r\n        message = \"wpLingua error - Load in progress: \" + message;\r\n        console.error(message);\r\n\r\n    }\r\n\r\n    $(\"#wplng-in-progress-error-close\").on(\"click\", function () {\r\n\r\n        $(\"#wplng-in-progress-container\").hide();\r\n        $(\"#wpadminbar\").show();\r\n\r\n        if (typeof wplngLoadInProgressData.urlReload === 'string') {\r\n            window.location.href = wplngLoadInProgressData.urlReload;\r\n        }\r\n    });\r\n\r\n    /**\r\n     * Update percentage for the load in progress bar\r\n     */\r\n\r\n    function wplngLoadInProgressUpdatePercentValue(percent) {\r\n        $(\"#wplng-in-progress-percent\").html(percent);\r\n        $(\"#wplng-progress-bar-value\").animate(\r\n            { width: percent.toString() + \"%\" },\r\n            500\r\n        );\r\n    }\r\n\r\n    function wplngLoadInProgressUpdatePercent() {\r\n        let percent = parseInt($(\"#wplng-in-progress-percent\").html());\r\n\r\n        if (percent < wplngLoadInProgressPercentageMin\r\n            && !wplngLoadInProgressErrorOccurred\r\n        ) {\r\n            wplngLoadInProgressUpdatePercentValue(wplngLoadInProgressPercentageMin);\r\n        } else if (percent < wplngLoadInProgressPercentageMax\r\n            && percent < 99\r\n            && !wplngLoadInProgressErrorOccurred\r\n        ) {\r\n            percent++;\r\n            wplngLoadInProgressUpdatePercentValue(percent);\r\n        }\r\n\r\n    }\r\n\r\n    wplngLoadInProgressUpdatePercent();\r\n\r\n    if ($(\"#wplng-in-progress-percent\").length) {\r\n        setInterval(wplngLoadInProgressUpdatePercent, 500);\r\n    }\r\n\r\n    if ($(\"#wpadminbar\").length && $(\"#wplng-in-progress-container\").length) {\r\n        $(\"#wpadminbar\").hide();\r\n    }\r\n\r\n}); // End jQuery loaded event"],"names":["jQuery","document","ready","$","let","wplngLoadInProgressPercentageMin","wplngLoadInProgressPercentageMax","wplngLoadInProgressErrorOccurred","wplngLoadInProgressError","message","hide","show","console","error","wplngLoadInProgressUpdatePercentValue","percent","html","animate","width","toString","wplngLoadInProgressUpdatePercent","parseInt","length","wplngLoadInProgressData","info","urlAjax","urlReload","nonce","language","chunks","wplngLoadInProgressProcessCkunk","counter","percentage","texts","ajax","url","method","data","action","wplng_language","wplng_texts","wplng_nonce","success","response","translations","map","Object","create","Array","isArray","forEach","t","source","trim","translation","each","domText","this","text","translated","replaceWith","window","location","href","error_message","on","setInterval"],"mappings":"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"}